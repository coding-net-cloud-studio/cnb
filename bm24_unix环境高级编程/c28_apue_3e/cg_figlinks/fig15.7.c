#include "apue.h"  // 引入apue库,该库提供了一系列系统编程的工具和函数

// 定义两个静态整数数组,用于存储两个管道的文件描述符
// 定义两个管道文件描述符数组,用于进程间通信
// pfd1[0] 和 pfd1[1] 分别表示管道1的读端和写端
// pfd2[0] 和 pfd2[1] 分别表示管道2的读端和写端
static int pfd1[2], pfd2[2];

/**
 * 初始化两个管道,用于父子进程间的通信.
 * 如果管道创建失败,将调用err_sys函数输出错误信息并终止程序.
 */

/**
 * TELL_WAIT 函数用于创建两对管道,用于父子进程间的同步.
 * 父进程向子进程发送信号以表明它已准备好接收数据,
 * 子进程向父进程发送信号以表明它已准备好接收数据.
 *
 * @return 无返回值,但会在管道创建失败时调用 err_sys 函数报告错误.
 */
void TELL_WAIT(void)
{
    // 创建两对管道,pfd1 用于父进程向子进程发送信号,pfd2 用于子进程向父进程发送信号
    if (pipe(pfd1) < 0 || pipe(pfd2) < 0)
        // 如果管道创建失败,调用 err_sys 函数报告错误
        err_sys("pipe error");
}

/**
 * 子进程向父进程发送信号,表示子进程已准备好.
 * 如果写入管道失败,将调用err_sys函数输出错误信息并终止程序.
 * @param pid 父进程的进程ID.
 */

/**
 * TELL_PARENT - 向父进程发送信号
 * @pid: 父进程的进程ID
 *
 * 该函数尝试向父进程发送一个信号,通过写入管道实现.
 * 如果写入操作失败,则调用err_sys函数报告错误.
 */
void TELL_PARENT(pid_t pid)
{
    // 尝试向管道pfd2的写入端写入一个字符'c'
    if (write(pfd2[1], "c", 1) != 1)
        // 如果写入的字节数不等于1,说明写入失败,调用err_sys报告错误
        err_sys("write error");
}

/**
 * 父进程等待子进程发送的信号.
 * 如果读取管道失败,将调用err_sys函数输出错误信息并终止程序.
 * 如果读取的数据不是预期的 'p',将调用err_quit函数输出错误信息并终止程序.
 */

/**
 * 等待父进程发送信号
 * 该函数通过读取管道中的数据来等待父进程的信号.
 * 如果读取失败或读取到的数据不是预期的字符'p',则调用错误处理函数.
 */
void WAIT_PARENT(void)
{
    char c;  // 用于存储从管道读取的数据

    // 尝试从管道的读端读取一个字节的数据
    if (read(pfd1[0], &c, 1) != 1)
    {
        err_sys("read error");  // 如果读取失败,调用系统错误处理函数
    }

    // 检查读取到的数据是否为预期的字符'p'
    if (c != 'p')
    {
        err_quit("WAIT_PARENT: incorrect data");  // 如果不是,调用退出错误处理函数
    }
}

/**
 * 父进程向子进程发送信号,表示父进程已准备好.
 * 如果写入管道失败,将调用err_sys函数输出错误信息并终止程序.
 * @param pid 子进程的进程ID.
 */

// TELL_CHILD 函数向子进程发送一个信号,告知它执行某个操作.
// 参数:
//   pid_t pid: 子进程的进程ID.
void TELL_CHILD(pid_t pid)
{
    // 尝试通过管道pfd1的写端写入一个字符'p'给子进程.
    // 如果写入的字节数不等于1,则表示发生了错误.
    if (write(pfd1[1], "p", 1) != 1)
        // 调用err_sys函数输出错误信息并退出程序.
        err_sys("write error");
}

/**
 * 子进程等待父进程发送的信号.
 * 如果读取管道失败,将调用err_sys函数输出错误信息并终止程序.
 * 如果读取的数据不是预期的 'c',将调用err_quit函数输出错误信息并终止程序.
 */
// 等待子进程结束的函数
// 该函数通过读取管道中的数据来判断子进程是否已经发送了结束信号
void WAIT_CHILD(void)
{
    char c;  // 用于存储从管道中读取的数据

    // 尝试从管道的读端读取一个字节的数据
    if (read(pfd2[0], &c, 1) != 1)
    {
        err_sys("read error");  // 如果读取失败,打印错误信息并退出程序
    }

    // 检查读取到的字节是否为'c',这是子进程结束的信号
    if (c != 'c')
    {
        err_quit("WAIT_CHILD: incorrect data");  // 如果不是预期的信号,打印错误信息并退出程序
    }
}
